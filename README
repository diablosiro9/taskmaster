# TaskMaster â€” Mandatory + Bonus
## 1. PrÃ©sentation gÃ©nÃ©rale

**TaskMaster** est un gestionnaire de processus inspirÃ© de *supervisord*.
Il permet de :

* lancer, arrÃªter, redÃ©marrer des programmes
* surveiller leur Ã©tat
* recharger la configuration Ã  chaud
* gÃ©rer lâ€™autostart, le multiâ€‘process, les crashs
* interagir via une **CLI avec autocomplÃ©tion et historique**
* (bonus) fonctionner en **daemon**, avec **socket**, **alerting**, **webhook**, **logs structurÃ©s**

Le projet est dÃ©coupÃ© en deux parties :

* **Mandatory** : mode interactif
* **Bonus** : mode daemon + client + alerting

---

## 2. Mandatory â€” dÃ©monstration complÃ¨te

### Lancement

```bash
./run_taskmaster.sh start
```

â¡ï¸ DÃ©marre TaskMaster en **mode interactif**.

### Commandes disponibles

* `status`
* `start <program>`
* `stop <program>`
* `restart <program>`
* `reload`
* `exit`

### AutocomplÃ©tion

* `TAB` complÃ¨te les commandes
* `TAB` complÃ¨te les noms de programmes
* historique des commandes fonctionnel

### DÃ©monstration type

```text
status
start fast_ok
status
reload
restart fast_ok
stop fast_ok
exit
```

---

## 3. Bonus â€” mode daemon

### DÃ©marrage du daemon

```bash
./bonus/run_taskmaster_bonus.sh start
```

â¡ï¸ TaskMaster fork en arriÃ¨reâ€‘plan

* PID stockÃ© dans `/tmp/taskmaster_daemon.pid`
* socket UNIX : `/tmp/taskmaster.sock`
* logs : `bonus/logs/daemon.log`

### ArrÃªt

```bash
./bonus/run_taskmaster_bonus.sh stop
```

---

## 4. Client bonus (socket)

### Commandes

```bash
python3 bonus/client.py status
python3 bonus/client.py start fast_ok
python3 bonus/client.py stop fast_ok
python3 bonus/client.py reload
python3 bonus/client.py shutdown
```

â¡ï¸ Communication via socket UNIX avec le daemon.

---

## 5. Gestion des programmes (bonus)

### Autostart

* Les programmes avec `autostart: true` sont lancÃ©s au dÃ©marrage du daemon

### Multiâ€‘process

```yaml
numprocs: 3
```

â¡ï¸ TaskMaster garantit le nombre dÃ©sirÃ© de processus.

### Crash & restart

* DÃ©tection automatique des sorties
* RedÃ©marrage si configurÃ©

---

## 6. Alerting (fichier + webhook)

### Principe

Chaque Ã©vÃ©nement gÃ©nÃ¨re une **alerte structurÃ©e** :

* `process_started`
* `process_exited`
* `process_stopped`
* `daemon_started`
* `daemon_stopping`

Une alerte peut Ãªtre envoyÃ©e **simultanÃ©ment** vers :

1. un **fichier de log dÃ©diÃ© aux alertes**
2. un **webhook HTTP**

â¡ï¸ Il nâ€™y a **aucune incompatibilitÃ©** entre les deux.

---

## 7. Alerting fichier

### Fichier

```text
bonus/logs/alerts.log
```

### Format

```json
{
  "timestamp": "2026-01-29 14:13:47",
  "event": "process_started",
  "payload": {
    "program": "fast_ok",
    "pid": 21560
  }
}
```

â¡ï¸ Lisible, parsable, compatible SIEM.

---

## 8. Webhook â€” dÃ©monstration

### Lancer le serveur de test

```bash
python3 bonus/webhook_demo.py
```

â¡ï¸ Ã‰coute sur :

```text
http://localhost:8080/webhook
```

### RÃ©sultat

* chaque alerte est reÃ§ue **en temps rÃ©el**
* affichÃ©e dans le terminal
* lisible depuis un navigateur / outil HTTP

â¡ï¸ **Le webhook nâ€™empÃªche pas lâ€™Ã©criture du fichier de log.**
Les deux sont exÃ©cutÃ©s dans la mÃªme fonction dâ€™alerting.

---

## 9. Ã€ propos des doublons (logs / alertes)

### Pourquoi il y a parfois des doublons ?

Actuellement :

* certains logs sont Ã©mis **avant le fork**
* puis rÃ©Ã©mis **aprÃ¨s le fork**

â¡ï¸ Effet visuel : lignes en double

### Important pour le jury

* **aucun bug fonctionnel**
* pas de perte dâ€™Ã©tat
* pas de double exÃ©cution rÃ©elle

### Nettoyage possible (non requis)

* dÃ©placer lâ€™initialisation des logs aprÃ¨s `daemonize()`
* ou protÃ©ger avec un flag `is_daemon`

---

## 10. Pourquoi "Increasing 0 -> N" apparaÃ®t au reload

Lors dâ€™un `reload` :

* TaskMaster **recalcule lâ€™Ã©tat cible**
* compare :

  * nombre de process en cours
  * nombre dÃ©sirÃ© (`numprocs`)

Exemple :

```text
Increasing 'multi_proc' 0 -> 3
```

â¡ï¸ signifie :

* aucun process actif
* configuration demande 3
* TaskMaster dÃ©marre 3 instances

MÃªme sans autostart :

* le reload synchronise lâ€™Ã©tat interne

â¡ï¸ **Comportement normal et attendu.**

---

## 11. Ã‰tat actuel du projet

âœ” Mandatory complet
âœ” Bonus daemon fonctionnel
âœ” Socket + client OK
âœ” Alerting fichier OK
âœ” Webhook fonctionnel
âœ” Reload Ã  chaud
âœ” Multiâ€‘process
âœ” Logs dÃ©taillÃ©s

---


# # TaskMaster

# TaskMaster is a process supervisor inspired by supervisord.  
# It manages programs lifecycle, restarts, configuration reloads, and provides both an interactive mode (mandatory) and a daemon mode (bonus).

# ---

# ## Mandatory Features

# - Program supervision (start / stop / restart)
# - Multiple processes per program (`numprocs`)
# - Autostart and autorestart policies
# - Exit code handling
# - Graceful stop with signals
# - Configuration reload (SIGHUP)
# - Robust SIGCHLD handling
# - Logging of process lifecycle events

# The mandatory part strictly follows the subject requirements and was not modified for bonus features.

# ---

# ## Bonus Features Implemented

# ### Daemon Mode
# - Double-fork daemonization
# - PID file: `/tmp/taskmaster_daemon.pid`
# - Lock file to prevent multiple instances
# - Proper signal handling (SIGTERM / SIGHUP)

# ### Client / Server Architecture
# - Daemon and client are separated
# - Communication via UNIX socket
# - Client sends commands (start, stop, status, reload, shutdown)

# ### Advanced Reload Logic
# - Dynamic scaling when `numprocs` changes
# - Disabled programs are respected across reloads
# - No unwanted restarts during reload

# ### Centralized Logging
# - Daemon logs redirected to file
# - Child processes stdout/stderr captured
# - Unified logging system

# ### External Alerting System
# TaskMaster implements an external alerting mechanism to report important supervision events.

# Alerts are written to:

/*
skMaster git:(master) âœ— ./bonus/run_taskmaster_bonus.sh start
ğŸ”¹ Starting TaskMaster daemon...
[TaskMaster] Daemon started (PID=73579)
âœ  TaskMaster git:(master) âœ— python3 bonus/client.py status          
fast_ok RUNNING 1/1
slow_start RUNNING 1/1
crash_loop RUNNING 2/2
manual_only RUNNING 1/1
multi_proc RUNNING 3/3
âœ  TaskMaster git:(master) âœ— python3 bonus/client.py status
fast_ok RUNNING 1/1
slow_start RUNNING 0/1
crash_loop RUNNING 0/2
manual_only RUNNING 1/1
multi_proc RUNNING 3/3
âœ  TaskMaster git:(master) âœ— python3 bonus/client.py status       
fast_ok RUNNING 0/1
slow_start RUNNING 0/1
crash_loop RUNNING 0/2
manual_only RUNNING 1/1
multi_proc RUNNING 3/3
âœ  TaskMaster git:(master) âœ— python3 bonus/client.py status crash_loop
fast_ok RUNNING 0/1
slow_start RUNNING 0/1
crash_loop RUNNING 0/2
manual_only RUNNING 0/1
multi_proc RUNNING 0/3
âœ  TaskMaster git:(master) âœ— python3 bonus/client.py start crash_loop
OK started crash_loop
âœ  TaskMaster git:(master) âœ— python3 bonus/client.py status           
fast_ok RUNNING 0/1
slow_start RUNNING 0/1
crash_loop RUNNING 0/2
manual_only RUNNING 0/1
multi_proc RUNNING 0/3
âœ  TaskMaster git:(master) âœ— python3 bonus/client.py start manual_only
OK started manual_only
âœ  TaskMaster git:(master) âœ— python3 bonus/client.py stop manual_only
OK stopped manual_only
âœ  TaskMaster git:(master) âœ— python3 bonus/client.py stop             
ERR usage: stop <program>
âœ  TaskMaster git:(master) âœ— ./bonus/run_taskmaster_bonus.sh stop     
[TaskMaster] Stopping daemon (PID=73579)...
[TaskMaster] Daemon stopped
âœ  TaskMaster git:(master) âœ— clear

âœ  TaskMaster git:(master) âœ— ./bonus/run_taskmaster_bonus.sh start    
ğŸ”¹ Starting TaskMaster daemon...
[TaskMaster] Daemon started (PID=73833)
âœ  TaskMaster git:(master) âœ— python3 bonus/client.py status           
fast_ok RUNNING 0/1
slow_start RUNNING 0/1
crash_loop RUNNING 0/2
manual_only RUNNING 1/1
multi_proc RUNNING 3/3
âœ  TaskMaster git:(master) âœ— python3 bonus/client.py start crash_loop 
OK started crash_loop
âœ  TaskMaster git:(master) âœ— python3 bonus/client.py stop crash_loop  
OK stopped crash_loop
âœ  TaskMaster git:(master) âœ— python3 bonus/client.py status          
fast_ok RUNNING 0/1
slow_start RUNNING 0/1
crash_loop RUNNING 0/2
manual_only RUNNING 0/1
multi_proc RUNNING 0/3
âœ  TaskMaster git:(master) âœ— python3 bonus/client.py start multi_proc
OK started multi_proc
âœ  TaskMaster git:(master) âœ— python3 bonus/client.py status          
fast_ok RUNNING 0/1
slow_start RUNNING 0/1
crash_loop RUNNING 0/2
manual_only RUNNING 0/1
multi_proc RUNNING 3/3
âœ  TaskMaster git:(master) âœ— python3 bonus/client.py stop multi_proc 
OK stopped multi_proc
âœ  TaskMaster git:(master) âœ— ./bonus/run_taskmaster_bonus.sh stop     
[TaskMaster] Stopping daemon (PID=73833)...
[TaskMaster] Daemon stopped
âœ  TaskMaster git:(master) âœ— 
*/